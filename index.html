<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Primer-Style City: Crowd-Scaled Infection</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --w: 1100px; --gap: 12px; }
  body {
    margin: 0; background: #0f1115; color: #eaeef7;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display: grid; place-items: center; padding: 14px;
  }
  h1 { margin: 0 0 6px; font-size: clamp(18px, 3vw, 26px); }
  .meta { font-size: 12px; opacity: .8; margin-bottom: 8px; }
  .shell {
    width: min(96vw, var(--w));
    display: grid;
    grid-template-columns: 1fr 360px; /* sim left, chart right */
    gap: var(--gap);
    align-items: start;
  }
  @media (max-width: 900px){
    .shell { grid-template-columns: 1fr; }
  }
  #sim {
    width: 100%; height: auto; aspect-ratio: 16/9;
    border: 2px solid #2b3245; background: #161a22; border-radius: 8px;
  }
  #chartCard {
    border: 2px solid #2b3245; background: #10141c; border-radius: 8px;
    padding: 10px;
  }
  #chart { width: 100%; height: 300px; }
  .legend { font-size: 14px; display:flex; gap:12px; flex-wrap:wrap; margin-top: 6px; }
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;transform:translateY(1px)}
  .dot.h{background:lime}.dot.i{background:#ff4b4b}.dot.m{background:#4aa3ff}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Primer-Style City — Crowd-Scaled Infection</h1>
  <div class="meta">Agents walk to two buildings per day. Infection scales with infected count and crowding.</div>

  <div class="shell">
    <canvas id="sim" width="900" height="506"></canvas>

    <div id="chartCard">
      <canvas id="chart" width="360" height="300"></canvas>
      <div class="legend">
        <span><span class="dot h"></span> Healthy</span>
        <span><span class="dot i"></span> Infected</span>
        <span><span class="dot m"></span> Immune</span>
      </div>
    </div>
  </div>

<script>
/* ==========================
   Config
========================== */
const FRAMES_PER_DAY    = 300;                  // length of a sim “day”
const WINDOWS_PER_DAY   = 2;                    // two visits/day
const WINDOW_FRAMES     = FRAMES_PER_DAY / 2;   // frames per window
const BASE_INFECT       = 0.01;                 // base 1% per exposure
const CROWD_K           = 0.04;                 // crowd sensitivity (per extra visitor)
const MAX_INFECT_PROB   = 0.60;                 // cap per exposure
const START_INFECTED    = 0.05;                 // 5% initial infections
const SICK_DAYS         = 5;                    // infected -> immune
const IMMUNE_DAYS       = 3;                    // immune -> healthy
const SICK_FRAMES       = SICK_DAYS  * FRAMES_PER_DAY;
const IMMUNE_FRAMES     = IMMUNE_DAYS * FRAMES_PER_DAY;

const N_AGENTS = 80;
const AGENT_SPEED = 1.6;                        // px/frame
const ARRIVE_DIST2 = 64;                        // squared (8px radius)
const DWELL_FRAMES = 80;

const sim = document.getElementById('sim');
const ctx = sim.getContext('2d');
function rand(a,b){ return a + Math.random()*(b-a); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }

/* ==========================
   Buildings (3D-ish)
========================== */
class Building {
  constructor(x, y, w=42, h=28, height=rand(40, 90), hue=208) {
    this.x=x; this.y=y; this.w=w; this.h=h; this.height=height; this.hue=hue+rand(-8,8);
    this.visitorsThisWindow = new Set();
  }
  draw3D() {
    const x=this.x,y=this.y,w=this.w,h=this.h,z=this.height;
    const sx=0.6*(w+h)/2, sy=0.4*(w+h)/2;
    const face = `hsl(${this.hue} 25% 28%)`;
    const side = `hsl(${this.hue} 22% 22%)`;
    const topc = `hsl(${this.hue} 35% 42%)`;
    const glow = ctx.createRadialGradient(x,y,8,x,y,100);
    glow.addColorStop(0,'rgba(80,120,255,0.12)');
    glow.addColorStop(1,'rgba(80,120,255,0)');
    ctx.fillStyle = glow;
    ctx.beginPath(); ctx.ellipse(x,y+8,w*1.6,h*1.4,0,0,Math.PI*2); ctx.fill();

    // front
    ctx.fillStyle=face; ctx.fillRect(x-w/2, y-h/2 - z, w, h+z);
    // right side
    ctx.fillStyle=side;
    ctx.beginPath();
    ctx.moveTo(x+w/2, y-h/2 - z);
    ctx.lineTo(x+w/2+sx, y-h/2 - z - sy);
    ctx.lineTo(x+w/2+sx, y+h/2 - sy);
    ctx.lineTo(x+w/2,   y+h/2);
    ctx.closePath(); ctx.fill();
    // top
    ctx.fillStyle=topc;
    ctx.beginPath();
    ctx.moveTo(x-w/2, y-h/2 - z);
    ctx.lineTo(x+w/2, y-h/2 - z);
    ctx.lineTo(x+w/2+sx, y-h/2 - z - sy);
    ctx.lineTo(x-w/2+sx, y-h/2 - z - sy);
    ctx.closePath(); ctx.fill();

    // outline
    ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=1;
    ctx.strokeRect(x-w/2, y-h/2 - z, w, h+z);
  }
}

/* ==========================
   Agents
========================== */
class Agent {
  constructor(x,y, infected=false){
    this.x=x; this.y=y;
    this.vx=rand(-0.7,0.7); this.vy=rand(-0.7,0.7);
    this.state= infected ? 'infected' : 'healthy';
    this.timer=0;
    this.plan=[]; this.targetIndex=0;
    this.mode='travel'; this.dwellLeft=0;
    this._taggedThisWindow=false;
  }
  pickTwo(buildings){
    const b0 = buildings[Math.floor(rand(0,buildings.length))];
    let b1=b0; while(b1===b0) b1 = buildings[Math.floor(rand(0,buildings.length))];
    this.plan=[b0,b1]; this.targetIndex=0; this.mode='travel'; this._taggedThisWindow=false;
  }
  target(){ return this.plan[this.targetIndex] || null; }
  seek(t){
    if(!t) return;
    const dx=t.x-this.x, dy=t.y-this.y;
    const d=Math.hypot(dx,dy)||1;
    const sp=AGENT_SPEED;
    this.vx=(dx/d)*sp; this.vy=(dy/d)*sp;
    this.x+=this.vx; this.y+=this.vy;
  }
  update(){
    // disease timers
    this.timer++;
    if(this.state==='infected' && this.timer>SICK_FRAMES){ this.state='immune'; this.timer=0; }
    else if(this.state==='immune' && this.timer>IMMUNE_FRAMES){ this.state='healthy'; this.timer=0; }

    if(this.mode==='travel'){
      const t=this.target(); this.seek(t);
      if(t && dist2(this.x,this.y,t.x,t.y) < ARRIVE_DIST2){ this.mode='dwell'; this.dwellLeft=DWELL_FRAMES; }
    } else if(this.mode==='dwell'){
      this.x+=this.vx*0.05; this.y+=this.vy*0.05; // idle wiggle
      if(--this.dwellLeft<=0) this.mode='drift';
    } else if(this.mode==='drift'){
      this.vx+=rand(-0.1,0.1); this.vy+=rand(-0.1,0.1);
      this.vx=clamp(this.vx,-0.8,0.8); this.vy=clamp(this.vy,-0.8,0.8);
      this.x+=this.vx; this.y+=this.vy;
    }

    this.x=clamp(this.x,6,sim.width-6); this.y=clamp(this.y,6,sim.height-6);
  }
  draw(){
    ctx.beginPath();
    if(this.state==='healthy') ctx.fillStyle='lime';
    if(this.state==='infected') ctx.fillStyle='#ff4b4b';
    if(this.state==='immune')  ctx.fillStyle='#4aa3ff';
    ctx.arc(this.x,this.y,5.5,0,Math.PI*2); ctx.fill();
  }
}

/* ==========================
   World Setup
========================== */
const buildings=[];
const cols=6, rows=3, pad=60;
const gx0=pad, gx1=sim.width - pad;
const gy0=pad+40, gy1=sim.height - pad-40;
for(let r=0;r<rows;r++){
  for(let c=0;c<cols;c++){
    const x = gx0 + (gx1-gx0)*(c/(cols-1));
    const y = gy0 + (gy1-gy0)*(r/(rows-1));
    buildings.push(new Building(x,y));
  }
}
const agents=[];
for(let i=0;i<N_AGENTS;i++){
  const a=new Agent(rand(80,sim.width-80), rand(80,sim.height-80), Math.random()<START_INFECTED);
  agents.push(a);
}

/* ==========================
   Day/Window Control
========================== */
let frame=0, day=0, windowIndex=0; // window 0 then 1 each day

function startDay(){
  day++; windowIndex=0;
  for(const b of buildings) b.visitorsThisWindow.clear();
  for(const a of agents){ a.pickTwo(buildings); a.mode='travel'; a._taggedThisWindow=false; }
  pushChartPoint();
}

function startWindow(){
  for(const b of buildings) b.visitorsThisWindow.clear();
  for(const a of agents){ a._taggedThisWindow=false; a.mode='travel'; a.dwellLeft=0; }
}

function endWindowProcessInfections(){
  for(const b of buildings){
    const visitors = Array.from(b.visitorsThisWindow);
    if(visitors.length===0) continue;
    const infectedCount = visitors.reduce((acc,a)=>acc+(a.state==='infected'),0);
    if(infectedCount===0) continue;

    const T = visitors.length;
    // Base multi-infected compounding: p_multi = 1 - (1 - BASE)^I
    let p = 1 - Math.pow(1 - BASE_INFECT, infectedCount);
    // Crowd amplification: +CROWD_K per extra head beyond 2
    const crowdFactor = 1 + CROWD_K * Math.max(0, T - 2);
    p = Math.min(MAX_INFECT_PROB, p * crowdFactor);

    for(const a of visitors){
      if(a.state==='healthy' && Math.random() < p){
        a.state='infected'; a.timer=0;
      }
    }
  }
}

/* ==========================
   Chart
========================== */
const chartCtx = document.getElementById('chart').getContext('2d');
const chartData = {
  labels: [],
  datasets: [
    { label:'Healthy',  data:[], borderColor:'lime',    fill:false, tension:0.15 },
    { label:'Infected', data:[], borderColor:'#ff4b4b', fill:false, tension:0.15 },
    { label:'Immune',   data:[], borderColor:'#4aa3ff', fill:false, tension:0.15 },
  ]
};
const simChart = new Chart(chartCtx, {
  type:'line',
  data: chartData,
  options: {
    animation:false, responsive:true, maintainAspectRatio:false,
    scales:{ y:{ beginAtZero:true, suggestedMax:N_AGENTS, grid:{ color:'rgba(200,210,240,.08)' }, ticks:{ color:'#dfe3f3' } },
             x:{ ticks:{ color:'#dfe3f3' }, grid:{ color:'rgba(200,210,240,.06)' } } },
    plugins:{ legend:{ labels:{ color:'#eaeef7' } } }
  }
});
function pushChartPoint(){
  const h=agents.filter(a=>a.state==='healthy').length;
  const i=agents.filter(a=>a.state==='infected').length;
  const m=agents.filter(a=>a.state==='immune').length;
  chartData.labels.push(String(day));
  chartData.datasets[0].data.push(h);
  chartData.datasets[1].data.push(i);
  chartData.datasets[2].data.push(m);
  simChart.update();
}

/* ==========================
   Render & Loop
========================== */
function drawGroundGrid(){
  ctx.save();
  ctx.strokeStyle='rgba(128,148,200,0.08)'; ctx.lineWidth=1;
  const step=40;
  for(let x=step/2;x<sim.width;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,sim.height); ctx.stroke(); }
  for(let y=step/2;y<sim.height;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(sim.width,y); ctx.stroke(); }
  ctx.restore();
}

function loop(){
  ctx.clearRect(0,0,sim.width,sim.height);
  drawGroundGrid();

  // buildings
  for(const b of buildings) b.draw3D();

  // agents
  for(const a of agents){
    a.update();
    const t=a.target();
    if(t){
      const near = dist2(a.x,a.y,t.x,t.y) < ARRIVE_DIST2*1.2;
      if((a.mode==='dwell' || near) && !a._taggedThisWindow){
        t.visitorsThisWindow.add(a);
        a._taggedThisWindow=true;
      }
    }
    a.draw();
  }

  // window/day timing
  frame++;
  const inWindowFrame = frame % WINDOW_FRAMES;
  if(inWindowFrame===0){
    if(frame>0){
      endWindowProcessInfections();
      windowIndex++;
      if(windowIndex>=WINDOWS_PER_DAY){
        pushChartPoint(); startDay();
      } else {
        for(const a of agents) a.targetIndex=1;
        startWindow();
      }
    }
  }

  requestAnimationFrame(loop);
}

/* boot */
startDay(); startWindow(); loop();
</script>
</body>
</html>
