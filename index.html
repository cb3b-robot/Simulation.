<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Primer Simulation â€“ Always in Buildings</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    margin: 0; background: #0f1115; color: #eaeef7;
    font-family: system-ui, sans-serif;
    display: grid; place-items: center; padding: 14px;
  }
  h1 { margin: 0 0 6px; font-size: clamp(18px, 3vw, 26px); }
  .shell {
    display: grid; grid-template-columns: 1fr 350px; gap: 12px;
    width: min(95vw, 1100px);
  }
  @media(max-width:900px){ .shell{ grid-template-columns:1fr; } }
  #sim { width:100%; aspect-ratio:16/9; background:#161a22; border:2px solid #2b3245; border-radius:8px; }
  #chartCard { border:2px solid #2b3245; background:#10141c; border-radius:8px; padding:8px; }
  #chart { width:100%; height:300px; }
  .legend { font-size:14px; display:flex; gap:12px; margin-top:6px; }
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .dot.h{background:lime}.dot.i{background:#ff4b4b}.dot.m{background:#4aa3ff}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Primer-Style Epidemic Simulation</h1>
<div class="shell">
  <canvas id="sim" width="900" height="500"></canvas>
  <div id="chartCard">
    <canvas id="chart"></canvas>
    <div class="legend">
      <span><span class="dot h"></span> Healthy</span>
      <span><span class="dot i"></span> Infected</span>
      <span><span class="dot m"></span> Immune</span>
    </div>
  </div>
</div>

<script>
/* ==== Config ==== */
const FRAMES_PER_DAY = 300;
const WINDOWS_PER_DAY = 2;
const WINDOW_FRAMES = FRAMES_PER_DAY / WINDOWS_PER_DAY;
const BASE_INFECT = 0.01;      // 1% base
const CROWD_K = 0.04;          // crowd sensitivity
const MAX_INFECT_PROB = 0.6;   // cap
const START_INFECTED = 0.05;
const SICK_DAYS = 5, IMMUNE_DAYS = 3;
const SICK_FRAMES = SICK_DAYS * FRAMES_PER_DAY;
const IMMUNE_FRAMES = IMMUNE_DAYS * FRAMES_PER_DAY;

const N_AGENTS = 80;
const SPEED = 2.0;

/* ==== Setup ==== */
const sim = document.getElementById("sim");
const ctx = sim.getContext("2d");
function rand(a,b){return a+Math.random()*(b-a);}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function dist(a,b,c,d){return Math.hypot(a-c,b-d);}

class Building {
  constructor(x,y){this.x=x;this.y=y;this.visitors=new Set();}
  draw(){ctx.fillStyle="orange";ctx.fillRect(this.x-10,this.y-10,20,20);}
}
class Agent {
  constructor(x,y,infected=false){
    this.x=x;this.y=y;this.state=infected?"infected":"healthy";
    this.timer=0; this.plan=[]; this.targetIndex=0;
  }
  pickTwo(builds){
    let b1=builds[Math.floor(Math.random()*builds.length)];
    let b2=b1; while(b2===b1) b2=builds[Math.floor(Math.random()*builds.length)];
    this.plan=[b1,b2]; this.targetIndex=0;
  }
  target(){return this.plan[this.targetIndex];}
  update(){
    this.timer++;
    if(this.state==="infected"&&this.timer>SICK_FRAMES){this.state="immune";this.timer=0;}
    else if(this.state==="immune"&&this.timer>IMMUNE_FRAMES){this.state="healthy";this.timer=0;}
    // move to target
    const t=this.target();
    const d=dist(this.x,this.y,t.x,t.y);
    if(d>2){ this.x+=((t.x-this.x)/d)*SPEED; this.y+=((t.y-this.y)/d)*SPEED; }
  }
  draw(){
    ctx.beginPath();
    ctx.fillStyle=this.state==="healthy"?"lime":this.state==="infected"?"red":"blue";
    ctx.arc(this.x,this.y,5,0,Math.PI*2); ctx.fill();
  }
}

/* Buildings in grid */
const buildings=[];
for(let i=0;i<6;i++) for(let j=0;j<3;j++)
  buildings.push(new Building(120+i*120,100+j*120));

/* Agents */
const agents=[];
for(let i=0;i<N_AGENTS;i++)
  agents.push(new Agent(rand(50,850),rand(50,450),Math.random()<START_INFECTED));

/* ==== Infection ==== */
function processInfections(){
  for(const b of buildings){
    if(b.visitors.size===0) continue;
    const visitors=[...b.visitors];
    const I=visitors.filter(a=>a.state==="infected").length;
    if(I===0) continue;
    const T=visitors.length;
    let p=1-Math.pow(1-BASE_INFECT,I);
    p=Math.min(MAX_INFECT_PROB,p*(1+CROWD_K*Math.max(0,T-2)));
    for(const a of visitors) if(a.state==="healthy"&&Math.random()<p){a.state="infected";a.timer=0;}
  }
}

/* ==== Chart ==== */
const chartCtx=document.getElementById("chart").getContext("2d");
const chartData={labels:[],datasets:[
  {label:"Healthy",data:[],borderColor:"lime",fill:false},
  {label:"Infected",data:[],borderColor:"red",fill:false},
  {label:"Immune",data:[],borderColor:"blue",fill:false}
]};
const chart=new Chart(chartCtx,{type:"line",data:chartData,options:{animation:false,responsive:true,scales:{y:{beginAtZero:true,max:N_AGENTS}}}});
function pushChart(day){
  chartData.labels.push(day);
  chartData.datasets[0].data.push(agents.filter(a=>a.state==="healthy").length);
  chartData.datasets[1].data.push(agents.filter(a=>a.state==="infected").length);
  chartData.datasets[2].data.push(agents.filter(a=>a.state==="immune").length);
  chart.update();
}

/* ==== Simulation Loop ==== */
let frame=0, day=0, windowIndex=0;
function startDay(){ day++; windowIndex=0; for(const a of agents) a.pickTwo(buildings); pushChart(day); }
function startWindow(){ for(const b of buildings) b.visitors.clear(); }
function endWindow(){ processInfections(); windowIndex++; if(windowIndex>=WINDOWS_PER_DAY){startDay();} else {for(const a of agents) a.targetIndex=1; startWindow();}}

function loop(){
  ctx.clearRect(0,0,sim.width,sim.height);
  for(const b of buildings) b.draw();
  for(const a of agents){ a.update(); a.draw(); a.target().visitors.add(a);}
  frame++;
  if(frame%WINDOW_FRAMES===0){ endWindow(); }
  requestAnimationFrame(loop);
}
startDay(); startWindow(); loop();
</script>
</body>
</html>
